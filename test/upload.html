<html>

    <head>

    </head>

    <body>
        <input id="input" type="file">

        <script>
            var input = document.body.querySelector('#input');
            input.addEventListener('change', function(e) {
                var file = this.files[0];
                debugger
                test.upload(file, file.name, 'todo', 'bioformat', file.type, function(file, msg, result){
                });
            });

            var test = {
                upload: function(fileContent, name, parentId, bioFormat, format, callback) {
                    var blob = new Blob([fileContent], {
                        type: 'text/plain'
                    });
                    var config = {
                        blob: blob,
                        name: name,
                        parentId: parentId,
                        // userId: Cookies("bioinfo_user"),
                        // sid: Cookies("bioinfo_sid"),
                        userId: 'paco',
                        sid: 'sid',
                        format: 'PLAIN',
                        bioFormat: bioFormat,
                        callbackProgress: function(chunk, total, response) {
                            var percentProgress = Math.round((chunk.id / total) * 100);
                            console.log(percentProgress);
                            if (chunk.last) {
                                console.log(response);
                                callback(response);
                            }
                        },
                        error: function(msg, result) {
                            console.log(msg);
                            callback(null, msg, result);
                        }
                    };

                    config.url = 'http://localhost:5555/file/upload';
                    test._uploadFile(config);
                },
                _uploadFile: function(args) {
                    var url = args.url;
                    var blob = args.blob;
                    var name = args.name;
                    var parentId = args.parentId;
                    var userId = args.userId;
                    var format = args.format;
                    var bioFormat = args.bioFormat;
                    var callbackProgress = args.callbackProgress;

                    /**/
                    var resume = true;
                    var resumeInfo = {};
                    var chunkMap = {};
                    var chunkId = 0;
                    // var BYTES_PER_CHUNK = 2 * 1024 * 1024;
                    var BYTES_PER_CHUNK = 5;
                    var SIZE = blob.size;
                    var NUM_CHUNKS = Math.max(Math.ceil(SIZE / BYTES_PER_CHUNK), 1);
                    var start;
                    var end;

                    var getResumeInfo = function(formData) {
                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', url, false); //false = sync call
                        xhr.send(formData);
                        console.log(xhr.responseText);
                        // var response = JSON.parse(xhr.responseText);
                        // return response.response[0];
                        return xhr.responseText;
                    };
                    var checkChunk = function(id, size, resumeInfo) {
                        if (typeof resumeInfo[id] === 'undefined') {
                            return false;
                        } else if (resumeInfo[id].size != size /*|| resumeInfo[id].hash != hash*/ ) {
                            return false;
                        }
                        return true;
                    };
                    var processChunk = function(c) {
                        console.log(blob);
                        var chunkBlob = blob.slice(c.start, c.end);

                        if (checkChunk(c.id, chunkBlob.size, resumeInfo) == false) {
                            var formData = new FormData();
                            formData.append('chunk_id', c.id);
                            formData.append('chunk_size', chunkBlob.size);
                            /*formData.append('chunk_hash', hash);*/
                            formData.append("name", name);
                            formData.append('userId', userId);
                            formData.append('parentId', parentId);
                            /*formData.append('chunk_gzip', );*/
                            if (c.last) {
                                formData.append("last_chunk", true);
                                formData.append("total_size", SIZE);
                                formData.append("format", format);
                                formData.append("bioFormat", bioFormat);
                            }
                            formData.append('chunk_content', chunkBlob);

                            uploadChunk(formData, c, function(chunkResponse) {
                                callbackProgress(c, NUM_CHUNKS, chunkResponse);
                                if (!c.last) {
                                    processChunk(chunkMap[(c.id + 1)]);
                                } else {

                                }
                            });
                        } else {
                            callbackProgress(c, NUM_CHUNKS);
                            if (!c.last) {
                                processChunk(chunkMap[(c.id + 1)]);
                            } else {

                            }
                        }

                    };
                    var uploadChunk = function(formData, chunk, callback) {
                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', url, true);
                        xhr.onload = function(e) {
                            chunk.done = true;
                            console.log("chunk done");
                            callback(JSON.parse(xhr.responseText));
                        };
                        xhr.send(formData);
                    };

                    /**/
                    /**/

                    if (resume) {
                        var resumeFormData = new FormData();
                        resumeFormData.append('resume_upload', resume);
                        resumeFormData.append('name', name);
                        resumeFormData.append('userId', userId);
                        resumeFormData.append('parentId', parentId);
                        resumeInfo = getResumeInfo(resumeFormData);
                    }

                    start = 0;
                    end = BYTES_PER_CHUNK;
                    while (start < SIZE) {
                        var last = false;
                        if (chunkId == (NUM_CHUNKS - 1)) {
                            last = true;
                        }
                        chunkMap[chunkId] = {
                            id: chunkId,
                            start: start,
                            end: end,
                            done: false,
                            last: last
                        };
                        start = end;
                        end = start + BYTES_PER_CHUNK;
                        chunkId++;
                    }
                    processChunk(chunkMap[0]);

                }
            }



            var text = "hola que pasa como estas";
            var testBlob = new Blob([text], {type: 'text/plain'});
            test.upload(testBlob, 'test.txt', 'todo', 'bioformat', testBlob.type, function(file, msg, result){
                debugger
            });

        </script>


    </body>

</html>
